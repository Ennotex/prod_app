<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Validation de production - Valide_BAT-8584-V1.pdf</title>

  <style>
    body { margin:0; font-family:Arial, sans-serif; visibility:hidden; }
    #page-main, #page-signature { display:none; }
  </style>

  <script>
    /* --- CONFIGURATION IP GUARD + MOT DE PASSE --- */
    const ALLOWED_IP_PREFIXES = ["82.96.163."];  
    const PASSWORD = "ENNOTEX2025!";

    function isAllowedIP(ip){
      return ALLOWED_IP_PREFIXES.some(p => ip.startsWith(p));
    }

    function showPage(pageId){
      document.getElementById("page-main").style.display = "none";
      document.getElementById("page-signature").style.display = "none";
      document.getElementById(pageId).style.display = "block";
    }

    function showApp(){
      document.body.style.visibility = "visible";
      showPage("page-main");
      const ov = document.getElementById("ip-guard-overlay");
      if (ov) ov.remove();
    }

    function deny(){
      const ip = window.__client_ip || "inconnue";

      const overlay = document.createElement("div");
      overlay.id = "ip-guard-overlay";
      overlay.style.position = "fixed";
      overlay.style.inset = "0";
      overlay.style.display = "flex";
      overlay.style.alignItems = "center";
      overlay.style.justifyContent = "center";
      overlay.style.background = "#f5f5f5";

      overlay.innerHTML = `
        <div style="padding:24px;background:#fff;border-radius:12px;max-width:360px;text-align:center;box-shadow:0 0 14px rgba(0,0,0,.1)">
          <h2 style="margin:0 0 10px">Acc√®s refus√©</h2>
          <p>Cette page est r√©serv√©e aux ateliers ENNOTEX.</p>
          <p style="font-size:13px;color:#555;margin:8px 0">IP d√©tect√©e : <strong>${ip}</strong></p>

          <input id="pw"
            type="password"
            placeholder="Mot de passe atelier"
            style="margin-top:10px;padding:10px;width:90%;border-radius:6px;border:1px solid #ccc"/>

          <div id="pw-error" style="color:#c00;font-size:13px;margin-top:6px;display:none"></div>

          <button onclick="checkPw()" style="margin-top:12px;padding:10px 18px;background:#0033cc;color:#fff;border:none;border-radius:6px;cursor:pointer">
            D√©verrouiller
          </button>
        </div>
      `;
      document.body.appendChild(overlay);
      document.body.style.visibility = "visible";
    }

    function checkPw(){
      const v = document.getElementById("pw").value.trim();
      if (v === PASSWORD){
        try { sessionStorage.setItem("ip_ok","1"); } catch {}
        showApp();
      } else {
        document.getElementById("pw-error").innerHTML = "Mot de passe incorrect.";
        document.getElementById("pw-error").style.display = "block";
      }
    }

    (async () => {
      try{
        if (sessionStorage.getItem("ip_ok") === "1"){
          showApp();
          return;
        }
      }catch{}

      let ip = "";
      try {
        const r6 = await fetch("https://api64.ipify.org?format=json");
        ip = (await r6.json()).ip || "";
      } catch {}

      if (!ip){
        const r4 = await fetch("https://api.ipify.org?format=json");
        ip = (await r4.json()).ip || "";
      }

      ip = ip.toLowerCase();
      window.__client_ip = ip;

      if (isAllowedIP(ip)) showApp();
      else deny();
    })();
  </script>


  <style>
    .container {
      background:#fff;
      padding:28px;
      border-radius:12px;
      box-shadow:0 0 12px rgba(0,0,0,0.1);
      max-width:600px;
      width:90%;
      margin:auto;
      text-align:center;
    }
    button {
      margin:10px 0;
      padding:15px 25px;
      font-size:16px;
      border:none;
      border-radius:8px;
      cursor:pointer;
      color:#fff;
    }
    .blue { background:#0033cc; }
    .blue:hover{ background:#001a80; }
    .green{ background:#28a745; }
    .orange{ background:#ff8c00; }
    .purple{ background:#8e44ad; }

    /* PAGE SIGNATURE ‚Äî VERSION 3 */
    #page-signature {
      height:100vh;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      padding:20px;
      background:#fff;
    }
    #sig-name {
      padding:10px;
      font-size:18px;
      border-radius:6px;
      border:1px solid #ccc;
      width:100%;
      margin-bottom:14px;
    }
    #sig-canvas {
      flex:1;
      border:1px solid #ccc;
      border-radius:8px;
      background:#fafafa;
      touch-action:none;
    }
    #sig-buttons {
      margin-top:14px;
    }
    #sig-buttons button {
      width:100%;
      margin-bottom:10px;
      font-size:18px;
    }
  </style>

</head>
<body>

  <!-- PAGE PRINCIPALE -->
  <div id="page-main">
    <div class="container">

      <h1>Valide_BAT-8584-V1.pdf</h1>
      <p>Merci de suivre les √©tapes ci-dessous :</p>

      <button class="blue" onclick="window.open('https://drive.google.com/file/d/17avSOAIGdk8pI-_-Hi7CyWliyyizh__3/preview','_blank')">üìÑ Visualiser le BAT</button><br>
      <button class="blue" onclick="window.open('https://forms.fillout.com/t/jmLpPYCEfxus?ref=1WsWmpZqR1tH58Lv4TAhApskR_Av3ZU5F','_blank')">üì∏ Envoyer les fichiers de production</button><br>
      <button class="blue" onclick="window.open('','_blank')">üîç Comparer le BAT et le premier test</button><br>
      <button class="green" onclick="window.open('https://drive.google.com/drive/folders/1WsWmpZqR1tH58Lv4TAhApskR_Av3ZU5F','_blank')">üìÇ Acc√©der au dossier</button>

      <!-- Bloc transport -->
      <div style="margin-top:20px">
        <label for="gls-qty" style="font-weight:bold">Nombre de colis</label>
        <input id="gls-qty" type="number" min="1" value="1"
          style="padding:10px;margin-top:8px;width:140px;border-radius:8px;border:1px solid #ccc;text-align:center"/>

        <button id="btn-gls" class="orange" onclick="createGLS()">üöö Cr√©er l‚Äô√©tiquette de transport</button>
      </div>

      <hr style="margin:30px 0;opacity:0.3">

      <!-- BOUTON SIGNATURE PAGE 2 -->
      <button class="purple" onclick="showPage('page-signature')">‚úçÔ∏è Faire signer le retrait showroom</button>

    </div>
  </div>
  <!-- PAGE SIGNATURE (PLEIN √âCRAN mobile-friendly) -->
  <div id="page-signature">

    <input id="sig-name" type="text" placeholder="Pr√©nom du retraitant">

    <canvas id="sig-canvas"></canvas>

    <div id="sig-buttons">
      <button class="green" onclick="sendRetrait()">üìã Valider le retrait</button>
      <button class="blue" onclick="showPage('page-main')">‚Ü©Ô∏è Retour</button>
    </div>

  </div>


  <!-- LIBRAIRIE PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    const WEBHOOK_GLS = "https://hook.eu1.make.com/brxbqvpfpgh2mgrwuvpm5gui6qojznwn";
    const WEBHOOK_RETRAIT = "https://hook.eu1.make.com/eh9gjwpilx7uta7o587l2zoz0hvm5g3p";

    async function sendToWebhook(url, payload){
      const res = await fetch(url,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(payload)
      });
      return res.ok;
    }

    /* --- GLS --- */
    async function createGLS(){
      const qty = Math.max(1, parseInt(document.getElementById("gls-qty").value,10) || 1);
      const btn = document.getElementById("btn-gls");

      btn.disabled = true;
      btn.innerHTML = "‚è≥ Cr√©ation‚Ä¶";

      const payload = {
        action:"create_gls_label",
        nb_colis: qty,
        context:{
          name:"Valide_BAT-8584-V1.pdf",
          preview_url:"https://drive.google.com/file/d/17avSOAIGdk8pI-_-Hi7CyWliyyizh__3/preview",
          upload_url:"https://forms.fillout.com/t/jmLpPYCEfxus?ref=1WsWmpZqR1tH58Lv4TAhApskR_Av3ZU5F",
          compare_url:"",
          drive_folder:"https://drive.google.com/drive/folders/1WsWmpZqR1tH58Lv4TAhApskR_Av3ZU5F",
          drive_file_id:"1WsWmpZqR1tH58Lv4TAhApskR_Av3ZU5F",
          id_devis_sellsy:"53123570",
          id_opp_sellsy:"11237710",
          number_devis:"DEV-20251201-08584",
          name_client:"CLIENT TEST",
          id_company:"39021759",
          mail_client:"louise@ennotex.fr",
          prenom:"Leo"
        },
        client:{
          ip:(window.__client_ip||""),
          ua:navigator.userAgent,
          at:new Date().toISOString()
        }
      };

      const ok = await sendToWebhook(WEBHOOK_GLS, payload);
      alert(ok ? "‚úÖ √âtiquette GLS envoy√©e" : "‚ùå Erreur d‚Äôenvoi");

      btn.disabled = false;
      btn.innerHTML = "üöö Cr√©er l‚Äô√©tiquette de transport";
    }

    /* --- SIGNATURE PAGE 2 --- */
    const canvas = document.getElementById("sig-canvas");
    const ctx = canvas.getContext("2d");

    function resizeCanvas(){
      canvas.width = canvas.clientWidth;
      canvas.height = canvas.clientHeight;
    }
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);

    let drawing = false;

    function startDraw(e){
      drawing = true;
      ctx.beginPath();
      moveDraw(e);
    }
    function endDraw(){ drawing=false; }
    function moveDraw(e){
      if (!drawing) return;
      const rect = canvas.getBoundingClientRect();
      const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
      const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
      ctx.lineWidth = 3;
      ctx.lineCap = "round";
      ctx.strokeStyle = "#000";
      ctx.lineTo(x,y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x,y);
    }

    canvas.addEventListener("mousedown", startDraw);
    canvas.addEventListener("mouseup", endDraw);
    canvas.addEventListener("mousemove", moveDraw);
    canvas.addEventListener("touchstart", startDraw);
    canvas.addEventListener("touchend", endDraw);
    canvas.addEventListener("touchmove", moveDraw);

    /* --- PDF + ENVOI --- */
    async function sendRetrait(){
      const name = document.getElementById("sig-name").value.trim();
      if (!name) return alert("Merci d‚Äôindiquer le pr√©nom du retraitant.");

      const sigData = canvas.toDataURL("image/png");
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(18);
      doc.text("Bon de retrait showroom",20,20);

      doc.setFontSize(12);
      doc.text(`Nom du retraitant : ${name}`,20,40);
      doc.text(`Client : CLIENT TEST`,20,50);
      doc.text(`N¬∞ de devis : DEV-20251201-08584`,20,60);
      doc.text(`Date : ${new Date().toLocaleString("fr-FR")}`,20,70);

      doc.text("Signature :",20,90);
      const img = new Image();
      img.src = sigData;
      await new Promise(res => img.onload = res);
      doc.addImage(img,"PNG",20,95,80,40);

      const pdfBase64 = doc.output("datauristring").split(",")[1];

      const payload = {
        action:"create_showroom_retrait",
        context:{
          name:"Valide_BAT-8584-V1.pdf",
          preview_url:"https://drive.google.com/file/d/17avSOAIGdk8pI-_-Hi7CyWliyyizh__3/preview",
          upload_url:"https://forms.fillout.com/t/jmLpPYCEfxus?ref=1WsWmpZqR1tH58Lv4TAhApskR_Av3ZU5F",
          compare_url:"",
          drive_folder:"https://drive.google.com/drive/folders/1WsWmpZqR1tH58Lv4TAhApskR_Av3ZU5F",
          drive_file_id:"1WsWmpZqR1tH58Lv4TAhApskR_Av3ZU5F",
          id_devis_sellsy:"53123570",
          id_opp_sellsy:"11237710",
          number_devis:"DEV-20251201-08584",
          name_client:"CLIENT TEST",
          id_company:"39021759",
          mail_client:"louise@ennotex.fr",
          prenom:"Leo"
        },
        retrait:{name, signature:sigData, pdf_base64:pdfBase64},
        client:{ua:navigator.userAgent, at:new Date().toISOString()}
      };

      const ok = await sendToWebhook(WEBHOOK_RETRAIT, payload);

      alert(ok ? "‚úÖ Retrait showroom enregistr√© !" : "‚ùå Erreur d‚Äôenvoi");
      showPage("page-main");
    }

  </script>

</body>
</html>