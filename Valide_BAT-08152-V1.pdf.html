<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Validation de production - Valide_BAT-08152-V1.pdf</title>

  <!-- AJOUT IP GUARD -->
  <style>body{visibility:hidden}</style>
  <script>
    const ALLOWED_IPS = new Set([
      "82.96.163.201",
      "82.96.163.204",
      "82.96.163.*",
      " 2a05:6e02:1040:6a10:6f17:81a7:c037:8e32",
"2a05:6e02:1040:6a10:cce2:e54f:713e:a228",
"2a05:6e02:1040:6a10:e555:3a61:d8b5:af3"
    ]);
    function deny(){
      document.body.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:center;min-height:100vh;font-family:Arial,sans-serif">
          <div style="max-width:560px;padding:24px;border-radius:12px;box-shadow:0 0 12px rgba(0,0,0,.1);background:#fff;text-align:center">
            <h2 style="margin:0 0 8px">Acc√®s refus√©</h2>
            <p style="margin:0 0 16px">Cette page est r√©serv√©e aux ateliers ENNOTEX.</p>
            <small style="color:#666">Si vous √™tes sur site, v√©rifiez que vous √™tes connect√© au r√©seau de l‚Äôatelier.</small>
          </div>
        </div>`;
      document.body.style.visibility = "visible";
    }
    (async () => {
      try {
        let ip = "";
        try {
          const r = await fetch("https://api64.ipify.org?format=json",{cache:"no-store"});
          ip = (await r.json()).ip || "";
        } catch {}
        if (!ip) {
          const r4 = await fetch("https://api.ipify.org?format=json",{cache:"no-store"});
          ip = (await r4.json()).ip || "";
        }
        ip = ip.toLowerCase();
        // expose l'IP au reste de la page
        window.__client_ip = ip;
        if (ALLOWED_IPS.has(ip)) document.body.style.visibility = "visible";
        else deny();
      } catch { deny(); }
    })();
  </script>
  <noscript>
    <style>body{visibility:visible}</style>
    <div style="padding:16px;background:#fff3cd;color:#664d03;text-align:center">
      JavaScript requis pour acc√©der √† cette page.
    </div>
  </noscript>
  <!-- /AJOUT IP GUARD -->

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: url('https://ennotex.github.io/assets/bg.jpg') no-repeat center center fixed;
      background-size: cover;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      background-color: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 12px;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    h1 { margin-bottom: 20px; }
    button {
      margin: 10px 0;
      padding: 15px 25px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background-color: #0033cc;
      color: white;
      transition: background-color 0.2s ease;
    }
    button:hover { background-color: #001a80; }
    .drive { background-color: #28a745; }
    .drive:hover { background-color: #1c7c31; }
    .gls { background-color: #ff8c00; }
    .gls:hover { background-color: #cc6f00; }
    .row { margin-top: 6px; }
    .row label { display:block; font-weight:600; margin-bottom:6px; }
    .row input[type="number"]{
      width: 140px; padding:10px; border:1px solid #ccc; border-radius:8px;
      text-align:center; font-size:16px;
    }
    small.muted{color:#666}
  </style>

  <!-- Webhook + logique GLS -->
  <script>
    const WEBHOOK_URL = "https://hook.eu1.make.com/brxbqvpfpgh2mgrwuvpm5gui6qojznwn";

    async function safeJson(r){ try{ return await r.json(); }catch{return null; } }

    async function sendToWebhook(payload){
      // tentative 1: POST JSON (si CORS autoris√©)
      try{
        const r = await fetch(WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          cache: "no-store",
          mode: "cors"
        });
        if (r.ok) return { ok:true, via:"fetch", status:r.status, data: await safeJson(r) };
        throw new Error("HTTP "+r.status);
      }catch(e){
        // tentative 2: Beacon (pas de CORS, pas de lecture r√©ponse)
        try{
          if (navigator.sendBeacon){
            const blob = new Blob([JSON.stringify(payload)], {type:"application/json"});
            navigator.sendBeacon(WEBHOOK_URL, blob);
            return { ok:true, via:"beacon" };
          }
        }catch{}
        // tentative 3: GET via image (encodage base64)
        try{
          const qs = new URLSearchParams({
            data: btoa(unescape(encodeURIComponent(JSON.stringify(payload))))
          });
          const img = new Image();
          img.src = WEBHOOK_URL + "?" + qs.toString();
          return { ok:true, via:"img" };
        }catch{}
        return { ok:false, error: e?.message || "send failed" };
      }
    }

    async function createGLS(){
      const qtyEl = document.getElementById("gls-qty");
      const btn = document.getElementById("btn-gls");
      const qty = Math.max(1, parseInt(qtyEl.value,10) || 1);

      btn.disabled = true;
      const lbl = btn.innerHTML;
      btn.innerHTML = "‚è≥ Cr√©ation en cours‚Ä¶";

      const payload = {
        action: "create_gls_label",
        nb_colis: qty,
        source: "validation_production",
        context: {
          name: "Valide_BAT-08152-V1.pdf",
          preview_url: "https://drive.google.com/file/d/11r7pIfXmbl_i82cbPnlXqUwDFZBKfxQN/preview",
          upload_url: "https://forms.fillout.com/t/jmLpPYCEfxus?ref=1EqFr-V1g8bc9fakHlze3qIsVEreW3Zh8",
          compare_url: "",
          drive_folder: "https://drive.google.com/drive/folders/1EqFr-V1g8bc9fakHlze3qIsVEreW3Zh8",
drive_file_id:"1EqFr-V1g8bc9fakHlze3qIsVEreW3Zh8",
id_devis_sellsy:"53122865",
id_opp_sellsy:"11237390",
number_devis:"DEV-20251013-08152",
name_client:"GH Club Gym"
        },
        client: {
          ip: (window.__client_ip || ""),
          ua: navigator.userAgent,
          at: new Date().toISOString()
        }
      };

      const res = await sendToWebhook(payload);
      btn.disabled = false;
      btn.innerHTML = lbl;

      if(res.ok){
        alert("‚úÖ Demande envoy√©e.\nNombre de colis : "+qty);
      }else{
        alert("‚ùå √âchec d‚Äôenvoi au webhook.\nD√©tail : "+(res.error||""));
      }
    }
  </script>
</head>
<body>
  <div class="container">
    <h1>Valide_BAT-08152-V1.pdf</h1>
    <p>Merci de suivre les √©tapes de validation ci-dessous :</p>

    <button onclick="window.open('https://drive.google.com/file/d/11r7pIfXmbl_i82cbPnlXqUwDFZBKfxQN/preview', '_blank')">üìÑ Visualiser le BAT</button><br>
    <button onclick="window.open('https://forms.fillout.com/t/jmLpPYCEfxus?ref=1EqFr-V1g8bc9fakHlze3qIsVEreW3Zh8', '_blank')">üì∏ Envoyer les fichiers de production</button><br>
    <button onclick="window.open('', '_blank')">üîç Comparer le BAT et le premier test</button><br>
    <button class="drive" onclick="window.open('https://drive.google.com/drive/folders/1EqFr-V1g8bc9fakHlze3qIsVEreW3Zh8', '_blank')">üìÇ Acc√©der au Dossier</button>

    <!-- Bloc GLS -->
    <div class="row" style="margin-top:18px">
      <label for="gls-qty">Nombre de colis</label>
      <input id="gls-qty" type="number" min="1" step="1" value="1" />
      <div><small class="muted">Indique le nombre d‚Äô√©tiquettes GLS √† g√©n√©rer.</small></div>
      <button id="btn-gls" class="gls" onclick="createGLS()">üì¶ Cr√©er l‚Äô√©tiquette de livraison</button>
    </div>
  </div>
</body>
</html>